# SPDX-License-Identifier: PMPL-1.0-or-later
name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6.0.2

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './src'
          severity: warning
          ignore_paths: tests

  syntax-check:
    name: Syntax Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6.0.2

      - name: Check Bash Syntax
        run: |
          find . -name "*.sh" -type f -exec bash -n {} \;

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6.0.2

      - name: Make scripts executable
        run: |
          chmod +x network-repair
          chmod +x src/main.sh
          chmod +x tests/*.sh
          find src -name "*.sh" -exec chmod +x {} \;

      - name: Run test suite
        run: ./tests/run-tests.sh

      - name: Run utility tests
        run: ./tests/test-utils.sh

  integration-tests:
    name: Integration Tests - ${{ matrix.os }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu:20.04
          - ubuntu:22.04
          - ubuntu:24.04
          - debian:11
          - debian:12

    container:
      image: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6.0.2

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y iproute2 iputils-ping dnsutils curl sudo

      - name: Make scripts executable
        run: |
          chmod +x network-repair
          chmod +x src/main.sh
          chmod +x tests/*.sh
          find src -name "*.sh" -exec chmod +x {} \;

      - name: Run diagnostics
        run: ./network-repair diagnose || true

      - name: Test help command
        run: ./network-repair --help

      - name: Test version command
        run: ./network-repair --version

  docker-test:
    name: Docker Build Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6.0.2

      - name: Create Dockerfile
        run: |
          cat > Dockerfile << 'EOF'
          FROM ubuntu:22.04
          RUN apt-get update && apt-get install -y \
              iproute2 \
              iputils-ping \
              dnsutils \
              curl \
              sudo \
              && rm -rf /var/lib/apt/lists/*
          COPY . /opt/network-repair
          WORKDIR /opt/network-repair
          RUN chmod +x network-repair src/main.sh
          RUN find src -name "*.sh" -exec chmod +x {} \;
          ENTRYPOINT ["/opt/network-repair/network-repair"]
          CMD ["--help"]
          EOF

      - name: Build Docker image
        run: docker build -t network-repair-test .

      - name: Test in Docker
        run: |
          docker run --rm network-repair-test --help
          docker run --rm network-repair-test --version
          docker run --rm --network host network-repair-test diagnose || true

  installation-test:
    name: Installation Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6.0.2

      - name: Make scripts executable
        run: |
          chmod +x install.sh
          chmod +x network-repair
          chmod +x src/main.sh
          find src -name "*.sh" -exec chmod +x {} \;

      - name: Test installation (dry-run)
        run: |
          # Test that install script syntax is valid
          bash -n ./install.sh

          # We can't actually install without root, but we can test the script
          echo "Installation script syntax is valid"
