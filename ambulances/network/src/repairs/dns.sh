#!/usr/bin/env bash
# DNS repair procedures

# Source utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/../utils/logging.sh"
source "${SCRIPT_DIR}/../utils/system.sh"
source "${SCRIPT_DIR}/../utils/privileges.sh"
source "${SCRIPT_DIR}/../utils/backup.sh"

# Repair DNS configuration
repair_dns_config() {
    log_section "DNS Configuration Repair"

    require_root "DNS configuration repair requires root privileges"

    local resolv_conf="/etc/resolv.conf"

    # Check if resolv.conf exists
    if [[ ! -f "${resolv_conf}" ]]; then
        log_step "Creating ${resolv_conf}"

        # Create basic resolv.conf
        cat > /tmp/resolv.conf.new << EOF
# Generated by network-repair tool
nameserver 8.8.8.8
nameserver 8.8.4.4
nameserver 1.1.1.1
EOF

        if run_privileged cp /tmp/resolv.conf.new "${resolv_conf}"; then
            run_privileged chmod 644 "${resolv_conf}"
            log_success "Created ${resolv_conf}"
            rm -f /tmp/resolv.conf.new
            return 0
        else
            log_error "Failed to create ${resolv_conf}"
            return 1
        fi
    fi

    # Check for nameservers
    local nameserver_count
    nameserver_count=$(grep -c "^nameserver" "${resolv_conf}" 2>/dev/null || echo 0)

    if [[ ${nameserver_count} -eq 0 ]]; then
        log_step "No nameservers found, adding default DNS servers"

        # Backup first
        backup_file "${resolv_conf}" "resolv.conf"

        # Add nameservers
        cat >> /tmp/resolv.conf.append << EOF

# Added by network-repair tool
nameserver 8.8.8.8
nameserver 8.8.4.4
nameserver 1.1.1.1
EOF

        if run_privileged bash -c "cat /tmp/resolv.conf.append >> ${resolv_conf}"; then
            log_success "Added DNS servers to ${resolv_conf}"
            rm -f /tmp/resolv.conf.append
            return 0
        else
            log_error "Failed to update ${resolv_conf}"
            return 1
        fi
    fi

    log_info "DNS configuration appears OK"
    return 0
}

# Reset DNS to defaults
reset_dns_to_defaults() {
    log_section "Reset DNS to Defaults"

    require_root "DNS reset requires root privileges"

    local resolv_conf="/etc/resolv.conf"

    # Backup current configuration
    if [[ -f "${resolv_conf}" ]]; then
        backup_file "${resolv_conf}" "resolv.conf"
    fi

    # Create new resolv.conf with reliable DNS servers
    log_step "Setting default DNS servers"

    cat > /tmp/resolv.conf.new << EOF
# Generated by network-repair tool
# Google DNS
nameserver 8.8.8.8
nameserver 8.8.4.4

# Cloudflare DNS
nameserver 1.1.1.1
nameserver 1.0.0.1

# Quad9 DNS
nameserver 9.9.9.9

options timeout:2 attempts:2
EOF

    if run_privileged cp /tmp/resolv.conf.new "${resolv_conf}"; then
        run_privileged chmod 644 "${resolv_conf}"
        log_success "DNS servers reset to defaults"
        rm -f /tmp/resolv.conf.new

        # Test DNS resolution
        log_step "Testing DNS resolution"
        if check_dns "google.com"; then
            log_success "DNS resolution is working"
            return 0
        else
            log_warn "DNS resolution still not working"
            return 1
        fi
    else
        log_error "Failed to reset DNS configuration"
        return 1
    fi
}

# Restart systemd-resolved
restart_systemd_resolved() {
    log_section "Restart systemd-resolved"

    require_root "Restarting systemd-resolved requires root privileges"

    if ! systemctl is-active --quiet systemd-resolved 2>/dev/null; then
        log_info "systemd-resolved is not active"
        return 0
    fi

    log_step "Restarting systemd-resolved service"

    if run_privileged systemctl restart systemd-resolved; then
        sleep 2

        if systemctl is-active --quiet systemd-resolved; then
            log_success "systemd-resolved restarted successfully"

            # Flush caches
            if command_exists resolvectl; then
                log_step "Flushing DNS cache"
                run_privileged resolvectl flush-caches 2>/dev/null && log_success "DNS cache flushed"
            fi

            return 0
        else
            log_error "systemd-resolved failed to start"
            return 1
        fi
    else
        log_error "Failed to restart systemd-resolved"
        return 1
    fi
}

# Flush DNS cache
flush_dns_cache() {
    log_section "Flush DNS Cache"

    require_root "Flushing DNS cache requires root privileges"

    local flushed=0

    # Flush systemd-resolved
    if systemctl is-active --quiet systemd-resolved 2>/dev/null; then
        log_step "Flushing systemd-resolved cache"
        if command_exists resolvectl; then
            run_privileged resolvectl flush-caches 2>/dev/null && {
                log_success "systemd-resolved cache flushed"
                flushed=1
            }
        fi
    fi

    # Flush nscd
    if systemctl is-active --quiet nscd 2>/dev/null; then
        log_step "Flushing nscd cache"
        run_privileged nscd -i hosts 2>/dev/null && {
            log_success "nscd cache flushed"
            flushed=1
        }
    fi

    # Flush dnsmasq
    if systemctl is-active --quiet dnsmasq 2>/dev/null; then
        log_step "Restarting dnsmasq"
        run_privileged systemctl restart dnsmasq && {
            log_success "dnsmasq restarted"
            flushed=1
        }
    fi

    if [[ ${flushed} -eq 0 ]]; then
        log_info "No DNS cache services found to flush"
    fi

    return 0
}

# Configure DNS via NetworkManager
configure_nm_dns() {
    log_section "Configure DNS via NetworkManager"

    if ! command_exists nmcli; then
        log_info "NetworkManager not available"
        return 0
    fi

    require_root "Configuring NetworkManager DNS requires root privileges"

    # Get active connection
    local active_conn
    active_conn=$(nmcli -t -f NAME connection show --active 2>/dev/null | head -1)

    if [[ -z "${active_conn}" ]]; then
        log_warn "No active NetworkManager connection"
        return 1
    fi

    log_step "Setting DNS for connection: ${active_conn}"

    # Set DNS servers
    if run_privileged nmcli connection modify "${active_conn}" ipv4.dns "8.8.8.8 8.8.4.4 1.1.1.1"; then
        log_success "DNS servers configured"

        # Restart connection
        log_step "Reactivating connection"
        run_privileged nmcli connection down "${active_conn}" 2>/dev/null || true
        sleep 1
        if run_privileged nmcli connection up "${active_conn}"; then
            log_success "Connection reactivated"
            return 0
        else
            log_error "Failed to reactivate connection"
            return 1
        fi
    else
        log_error "Failed to configure DNS servers"
        return 1
    fi
}

# Main DNS repair function
repair_dns() {
    log_section "DNS Repair"

    local total_issues=0

    # First, try simple fixes
    flush_dns_cache

    repair_dns_config
    total_issues=$((total_issues + $?))

    # If still broken, try more aggressive fixes
    if [[ ${total_issues} -gt 0 ]]; then
        log_warn "Basic DNS repair didn't fully resolve issues, trying advanced repairs"

        restart_systemd_resolved
        reset_dns_to_defaults
        configure_nm_dns
    fi

    # Final test
    log_section "DNS Repair Verification"
    if check_dns "google.com"; then
        log_success "DNS repair completed successfully"
        return 0
    else
        log_error "DNS repair did not fully resolve issues"
        return 1
    fi
}
