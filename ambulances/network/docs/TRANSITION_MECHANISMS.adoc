= IPv6 Transition Mechanisms - Complete Reference
:toc:
:toclevels: 3

== Overview

IPv6 transition mechanisms help IPv4-only networks connect to IPv6, or IPv6-only networks reach IPv4 destinations. Network Ambulance detects and diagnoses all major mechanisms.

== Dual-Stack (Preferred Method)

**Status:** ✅ Recommended, production-ready

**How it works:** Run IPv4 and IPv6 simultaneously

[source,console]
----
# Both protocols on same interface
eth0: <BROADCAST,MULTICAST,UP>
    inet 192.168.1.100/24
    inet6 2001:db8::1/64
    inet6 fe80::1234:5678/64
----

**Pros:**
* Native performance for both protocols
* No tunneling overhead
* Works with all applications
* Gradual migration path

**Cons:**
* Requires IPv6 support from ISP
* Double the routing/firewall config
* Address selection complexity

**Detection:**
[source,bash]
----
# Check for both stacks
ip -4 addr | grep "inet " && ip -6 addr | grep "inet6"
----

== Tunneling Mechanisms

=== 6to4 (RFC 3056) - DEPRECATED ❌

**Status:** ⚠️ DEPRECATED by RFC 7526, DO NOT USE

**How it works:** Automatic tunnel using public IPv4 address

[source,console]
----
# IPv4 address: 192.0.2.1
# Auto-derives 6to4 prefix: 2002:c000:0201::/48
#   where c000:0201 = 192.0.2.1 in hex
----

**Pros:**
* Automatic configuration
* No tunnel broker needed
* Works through NAT (sometimes)

**Cons:**
* Deprecated and being removed
* Relies on volunteer relays (unreliable)
* No security
* Poor performance
* Breaks when ISP changes IPv4

**Detection:**
[source,bash]
----
# Look for 2002::/16 addresses
ip -6 addr | grep "2002:"

# Check for 6to4 tunnel interface
ip link show | grep sit0
----

**Fix:**
[source,bash]
----
# Disable 6to4
modprobe -r sit
echo "blacklist sit" > /etc/modprobe.d/disable-6to4.conf

# Use native IPv6 or tunnel broker instead
----

=== Teredo (RFC 4380)

**Status:** ⚠️ Last resort, suboptimal

**How it works:** UDP tunneling through NAT

[source,console]
----
# Teredo prefix: 2001:0::/32
# Example: 2001:0:4137:9e76:1234:5678:90ab:cdef

# Components:
# 2001:0            - Teredo prefix
# 4137:9e76         - Teredo server IPv4
# 1234:5678         - Flags and obscured port
# 90ab:cdef         - Obscured client IPv4
----

**Pros:**
* Works through NAT
* Built into Windows
* No configuration needed

**Cons:**
* High latency (relay overhead)
* UDP only (blocked by some firewalls)
* Microsoft-controlled relays
* Unreliable

**Detection:**
[source,bash]
----
# Linux
ip -6 addr | grep "2001:0:"

# Windows
netsh interface teredo show state
----

**Fix:**
[source,bash]
----
# Windows: Disable Teredo
netsh interface teredo set state disabled

# Linux: Don't install miredo
# Request native IPv6 from ISP
----

=== ISATAP (RFC 5214)

**Status:** ⚠️ Enterprise-only, deprecated for general use

**How it works:** Tunnel within IPv4 infrastructure

[source,console]
----
# ISATAP address format:
# <prefix>::0:5efe:<IPv4-address>

# Example: 2001:db8::0:5efe:192.0.2.1
----

**Use case:** Enterprise internal IPv6 deployment

**Detection:**
[source,bash]
----
# Look for ::5efe: in addresses
ip -6 addr | grep "5efe"
----

=== Tunnel Brokers (Hurricane Electric, SixXS)

**Status:** ✅ Acceptable if no native IPv6

**How it works:** Configured tunnel to broker

[source,console]
----
# Hurricane Electric tunnel
Assigned /64: 2001:470:1234:5678::/64
IPv6 endpoint: Your tunnel server
IPv4 endpoint: Your public IP
----

**Pros:**
* Reliable (SLA from broker)
* Static IPv6 prefix
* Better than 6to4/Teredo
* Free (Hurricane Electric)

**Cons:**
* Additional latency
* Single point of failure
* Manual configuration
* Breaks if IPv4 changes

**Setup:**
[source,bash]
----
# Create tunnel interface
ip tunnel add he-ipv6 mode sit remote <SERVER-IPv4> local <YOUR-IPv4>
ip link set he-ipv6 up
ip -6 addr add <YOUR-IPv6>/64 dev he-ipv6
ip -6 route add default via <TUNNEL-IPv6> dev he-ipv6

# Persist in /etc/network/interfaces or NetworkManager
----

== Translation Mechanisms (IPv6-only to IPv4)

=== NAT64 (RFC 6146)

**Status:** ✅ Production-ready for IPv6-only networks

**How it works:** Stateful NAT from IPv6 to IPv4

[source]
----
[IPv6 Client] → [NAT64 Gateway] → [IPv4 Server]

1. Client sends to 64:ff9b::192.0.2.1
2. NAT64 extracts IPv4: 192.0.2.1
3. NAT64 translates and forwards to IPv4 server
4. NAT64 translates reply back to IPv6
----

**Well-Known Prefix:** `64:ff9b::/96` (RFC 6052)

**Detection:**
[source,bash]
----
# Query for IPv4-only domain
dig AAAA ipv4only.arpa

# If returns 64:ff9b::192.0.2.*, NAT64 is active
----

**Use case:** Mobile networks (T-Mobile, AT&T use this)

=== DNS64 (RFC 6147)

**Status:** ✅ Works with NAT64

**How it works:** Synthesizes AAAA from A records

[source]
----
# DNS64 server query for IPv4-only site:

1. Client queries: AAAA www.ipv4only.com
2. Server checks: AAAA exists? No.
3. Server queries: A www.ipv4only.com → 192.0.2.1
4. Server synthesizes: AAAA → 64:ff9b::192.0.2.1
5. Client gets AAAA, connects via NAT64
----

**Detection:**
[source,bash]
----
# Test DNS64
dig @<dns-server> AAAA ipv4only.arpa

# Should return synthesized AAAA if DNS64 active
----

**Problem:** Breaks DNSSEC validation

=== 464XLAT (RFC 6877)

**Status:** ✅ Standard for mobile IPv6-only networks

**Components:**
* **CLAT** (Customer-side LAT) - translates on device
* **PLAT** (Provider-side LAT) - NAT64 in network

[source]
----
[IPv4 App] → [CLAT] → [IPv6 Network] → [PLAT] → [IPv4 Internet]

# Special IPv4 prefix for CLAT: 192.0.0.0/29
----

**Detection:**
[source,bash]
----
# Android/iOS on IPv6-only network
ip addr show | grep "192.0.0"

# If present, 464XLAT active
----

**Use case:** T-Mobile, AT&T, Verizon LTE/5G

== Network Ambulance Detection

=== What Network Ambulance Detects

[source,json]
----
{
  "ipv6": {
    "transition_mechanisms": [
      {
        "type": "Teredo",
        "active": true,
        "endpoint": "2001:0:4137:9e76::1",
        "warnings": ["Teredo active - suboptimal performance"]
      },
      {
        "type": "NAT64",
        "active": true,
        "endpoint": "64:ff9b::/96",
        "warnings": []
      }
    ],
    "has_teredo_tunnel": true,
    "has_6to4_tunnel": false,
    "has_nat64": true
  }
}
----

=== Diagnostic Output

[source,console]
----
=== Transition Mechanisms ===
⚠ Teredo tunnel active
  Endpoint: 2001:0:4137:9e76::1
  → Disable Teredo, request native IPv6 from ISP

✓ NAT64 available
  Prefix: 64:ff9b::/96
  → Normal for IPv6-only mobile networks

✗ 6to4 detected (DEPRECATED)
  → Disable 6to4 immediately, use tunnel broker
----

== Transition Strategy Recommendations

[cols="2,1,3"]
|===
|Scenario |Method |Recommendation

|ISP provides native IPv6
|Dual-Stack
|✅ Use this (best performance)

|ISP no IPv6, you have public IPv4
|Tunnel Broker
|✅ Use Hurricane Electric or similar

|Behind NAT, need IPv6
|Teredo
|⚠️ Last resort only

|Enterprise internal
|ISATAP
|⚠️ Use dual-stack instead

|Mobile network IPv6-only
|464XLAT
|✅ Automatic, built-in

|IPv6-only network to IPv4 server
|NAT64/DNS64
|✅ Transparent to applications
|===

== Security Considerations

[cols="2,3,2"]
|===
|Mechanism |Security Risk |Mitigation

|6to4
|Unencrypted, unknown relays, no authentication
|Disable completely

|Teredo
|UDP tunneling, Microsoft-controlled
|Use only if no alternative

|Tunnel Broker
|Depends on broker security
|Use reputable brokers (HE, SixXS)

|NAT64
|Stateful translation, logs possible
|Accept for mobile, avoid for desktop

|ISATAP
|Internal only, authentication required
|Use VPN, restrict to trusted networks
|===

== Debugging Tools

[source,bash]
----
# Capture all IPv6 traffic
tcpdump -i eth0 ip6

# Capture only ICMPv6 (neighbor discovery, RA)
tcpdump -i eth0 'icmp6'

# Capture router advertisements specifically
tcpdump -i eth0 'icmp6 and ip6[40] == 134'

# Show active tunnels
ip -6 tunnel show

# Show all IPv6 routes
ip -6 route show table all

# Check what DNS server is being used
resolvectl status | grep "DNS Servers"
----

== References

* RFC 3056 - 6to4 (deprecated)
* RFC 4380 - Teredo
* RFC 5214 - ISATAP
* RFC 6146 - NAT64
* RFC 6147 - DNS64
* RFC 6877 - 464XLAT
* RFC 7526 - Deprecation of 6to4
* RFC 6052 - NAT64 Well-Known Prefix
