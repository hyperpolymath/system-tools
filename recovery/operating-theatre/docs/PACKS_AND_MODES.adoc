// SPDX-License-Identifier: PMPL-1.0-or-later
= Packs and Modes
:toc:
:toclevels: 3
:icons: font
:source-highlighter: rouge

This document defines the pack system for Operating Theatre — modular, platform-specific diagnostic and maintenance capabilities.

== Overview

Operating Theatre uses a **pack architecture** where functionality is delivered through composable modules rather than a monolithic application.

[source]
----
┌──────────────────────────────────────────────────────┐
│                  Operating Theatre                    │
│                    (Core Engine)                      │
├──────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐           │
│  │ Windows  │  │  Linux   │  │  macOS   │  Packs    │
│  │ Tech     │  │ Server   │  │ Desktop  │           │
│  │ Support  │  │ Health   │  │ Cleanup  │           │
│  └──────────┘  └──────────┘  └──────────┘           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐           │
│  │ Privacy  │  │ Security │  │ Dev      │  Packs    │
│  │ Guardian │  │ Hardener │  │ Tools    │           │
│  └──────────┘  └──────────┘  └──────────┘           │
└──────────────────────────────────────────────────────┘
----

== Pack Types

=== Platform Packs

Core functionality for specific operating systems:

[cols="1,2,2",options="header"]
|===
| Pack | Target | Focus

| `windows-tech-support`
| Windows 10/11
| Consumer diagnostics, cleanup, startup

| `linux-server-health`
| Linux (systemd)
| Server diagnostics, log analysis, services

| `macos-desktop`
| macOS 12+
| Desktop cleanup, app management

| `bsd-server`
| FreeBSD/OpenBSD
| Server health, jails/zones
|===

=== Category Packs

Cross-platform functionality by category:

[cols="1,2,2",options="header"]
|===
| Pack | Category | Features

| `privacy-guardian`
| Privacy
| Telemetry control, tracking prevention

| `security-hardener`
| Security
| Baseline hardening, vulnerability checks

| `network-diagnostics`
| Network
| Connectivity tests, DNS, latency

| `storage-analyzer`
| Storage
| Space analysis, duplicate detection
|===

=== Custom Packs

User or organization-defined packs:

* Enterprise configurations
* Specialized workflows
* Custom checks and actions

== Pack Structure

=== Directory Layout

[source]
----
windows-tech-support/
├── manifest.json          # Pack manifest (required)
├── README.adoc            # Documentation
├── checks/                # Check implementations
│   ├── disk-space.d       # D implementation
│   ├── startup-items.d
│   └── temp-files.d
├── actions/               # Action implementations
│   ├── clear-temp.d
│   └── disable-startup.d
├── ui/                    # UI configurations
│   ├── sections.json
│   └── strings.json
├── tests/                 # Test fixtures
│   └── mock-data/
└── CLAIMS.json            # Anti-fearware claims
----

=== Manifest Schema

[source,json]
----
{
  "version": "1.0.0",
  "pack_id": "windows-tech-support",
  "name": "Windows Tech Support Pack",
  "description": "Diagnostics for Windows consumer systems",
  "platform": {
    "os": ["windows"],
    "os_version_min": "10.0.19041",
    "arch": ["x86_64"]
  },
  "author": {
    "name": "AmbientOps",
    "email": "packs@ambientops.dev"
  },
  "license": "AGPL-3.0-or-later",
  "categories": ["disk", "startup", "cleanup", "performance"],
  "checks": [...],
  "actions": [...],
  "modes": {...},
  "claims": {...}
}
----

== Modes

Modes are predefined configurations for different use cases.

=== Standard Modes

[cols="1,2,3",options="header"]
|===
| Mode | Purpose | Characteristics

| `quick`
| Fast overview
| ~30 seconds, non-invasive, info only

| `standard`
| Regular maintenance
| ~2-5 minutes, safe actions available

| `deep`
| Thorough analysis
| ~10-30 minutes, all checks enabled

| `safe-only`
| Maximum safety
| Only fully reversible actions

| `expert`
| Full control
| All features, manual confirmation
|===

=== Mode Definition

[source,json]
----
{
  "modes": {
    "quick": {
      "name": "Quick Scan",
      "description": "Fast overview of system state",
      "enabled_checks": [
        "disk-space",
        "memory-usage",
        "startup-count"
      ],
      "disabled_checks": ["full-disk-scan", "driver-versions"],
      "auto_apply": false,
      "max_duration_seconds": 60
    },
    "standard": {
      "name": "Standard Scan",
      "description": "Regular maintenance scan",
      "enabled_checks": "*",
      "disabled_checks": ["deep-file-analysis"],
      "auto_apply": false,
      "max_duration_seconds": 300
    }
  }
}
----

=== Custom Modes

Users can define custom modes:

[source,json]
----
{
  "custom": [
    {
      "id": "my-weekly",
      "name": "My Weekly Cleanup",
      "based_on": "standard",
      "enabled_checks": ["disk-space", "temp-files", "downloads"],
      "auto_apply": true,
      "only_safe_actions": true
    }
  ]
}
----

== Checks

Checks are diagnostic operations that collect evidence.

=== Check Definition

[source,json]
----
{
  "check_id": "disk-space",
  "name": "Disk Space Analysis",
  "description": "Check available disk space",
  "category": "disk",
  "severity_if_found": "medium",
  "enabled_by_default": true,
  "requires_privileges": [],
  "estimated_duration_seconds": 5,
  "implementation": "checks/disk-space.d",
  "parameters": {
    "threshold_warning_percent": 80,
    "threshold_critical_percent": 95
  }
}
----

=== Check Requirements

Every check must:

. Produce evidence (artifacts)
. Report findings with evidence_refs
. Be non-mutating (read-only)
. Handle errors gracefully
. Respect timeout limits
. Support cancellation

== Actions

Actions are operations that modify system state.

=== Action Definition

[source,json]
----
{
  "action_id": "clear-temp-files",
  "name": "Clear Temporary Files",
  "description": "Remove temporary files from system and user directories",
  "risk": "safe",
  "reversibility": "partial",
  "requires_confirmation": true,
  "addresses_checks": ["temp-files", "disk-space"],
  "implementation": "actions/clear-temp.d",
  "parameters": {
    "include_system_temp": true,
    "include_user_temp": true,
    "older_than_days": 7
  }
}
----

=== Risk Levels

[cols="1,3,2",options="header"]
|===
| Level | Definition | Examples

| `safe`
| No data loss possible, easily reversible
| Clear temp files, disable startup item

| `guided`
| Some risk, requires understanding
| Uninstall program, modify service

| `expert`
| Significant impact, may be irreversible
| Registry modification, disk wipe
|===

=== Reversibility Levels

[cols="1,3,2",options="header"]
|===
| Level | Definition | Examples

| `full`
| Complete undo available
| Registry backup/restore, service disable/enable

| `partial`
| Some changes undoable
| Temp file cleanup (files gone but no harm)

| `none`
| Cannot be undone
| Secure file deletion, disk zeroing
|===

== Pack Lifecycle

=== Development

. Create pack directory structure
. Define manifest with checks/actions
. Implement check logic in D
. Implement action logic in D (with Rust for privileged ops)
. Write tests and mock data
. Document claims

=== Certification

. Anti-fearware compliance check
. Evidence chain verification
. Risk/reversibility accuracy audit
. UI language review
. Performance testing

=== Distribution

. Pack signing (cryptographic)
. Version compatibility check
. Dependency resolution
. Installation to pack directory

=== Updates

. Version comparison
. Changelog review
. Backup of existing pack
. Atomic update

== Claims and Compliance

Every pack must declare and honor anti-fearware claims.

=== Claims File

[source,json]
----
{
  "claims": {
    "no_fake_counts": {
      "value": true,
      "evidence": "All counts are direct enumerations"
    },
    "evidence_backed": {
      "value": true,
      "evidence": "All findings reference artifacts"
    },
    "user_controlled": {
      "value": true,
      "evidence": "No auto-apply without explicit consent"
    },
    "fully_reversible": {
      "value": false,
      "evidence": "Some cleanup actions are partial-reversible",
      "details": "clear-temp-files, clear-downloads marked as partial"
    },
    "open_source": {
      "value": true,
      "evidence": "Source available under AGPL-3.0"
    }
  }
}
----

=== Compliance Checking

[source,bash]
----
# Validate pack compliance
big-up pack validate ./windows-tech-support/

# Check specific claims
big-up pack check-claims ./windows-tech-support/

# Run certification suite
big-up pack certify ./windows-tech-support/
----

== Related Documents

* link:ANTI-FEARWARE.adoc[Anti-Fearware Principles]
* link:CLAIMS_POLICY.adoc[Claims Policy]
* link:WINDOWS_TECH_PACK_SCOPE.adoc[Windows Tech Support Pack Scope]
* `system-tools-contracts/schemas/pack-manifest.schema.json`
